/**
    Touch box - Enabled resize, drag & rotate of DOM elements on the web for iPad and other touch devices.
    Copyright (C) 2013 Dannie Hansen
 
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
 **/
(function(e){"use strict";function f(e,t,n,r){var i=e-n,s=t-r,o=Math.atan2(s,i);return o*180/Math.PI}var t,n=400,r="Transform",i="TransformOrigin",s=["O","ms","Webkit","Moz"],o=s.length,u=document.createElement("div"),a=u.style;while(o--){if(s[o]+r in a){r=s[o]+r;i=s[o]+i}}e.fn.TouchBox=function(s){var o={drag:false,resize:false,rotate:false,grid_drag:1,callback_touches:null,callback_size_change:null,callback_position_change:null,callback_degree_change:null};if(s!=t)e.extend(o,s);this.each(function(){var t=e(this);e.data(t[0],"options",o);e.data(t[0],"touches",0);e.data(t[0],"diffX",0);e.data(t[0],"diffY",0);e.data(t[0],"startWidth",0);e.data(t[0],"startHeight",0);e.data(t[0],"startDistance",0);e.data(t[0],"ignoreTouch",false);e.data(t[0],"startX",0);e.data(t[0],"startY",0);e.data(t[0],"rotatePoint1X",0);e.data(t[0],"rotatePoint1Y",0);e.data(t[0],"rotatePoint2X",0);e.data(t[0],"rotatePoint2Y",0);e.data(t[0],"rotation",false);e.data(t[0],"startDegree",0);e.data(t[0],"currDegree",0);e.data(t[0],"_startDegree",0);if(o.rotate)t.css(i,"center center");this.draggable=false;t.unbind("touchstart.touchBox mousedown.touchBox").bind("touchstart.touchBox mousedown.touchBox",function(r){var i=e(this),s=typeof r.pageX!="undefined"?r.pageX:r.originalEvent.touches[0].pageX,o=typeof r.pageY!="undefined"?r.pageY:r.originalEvent.touches[0].pageY,u=e.data(i[0],"ignoreTouch"),a=typeof r.pageX!="undefined"?1:r.originalEvent.touches.length,l=e.data(i[0],"options");n+=1;i.css({zIndex:n});e.data(i[0],"touches",a);if(u){u=false;e.data(i[0],"ignoreTouch",u)}if(!u){var c=parseFloat(i.css("left"),10),h=parseFloat(i.css("top"),10),p=s,d=o;e.data(i[0],"startX",c);e.data(i[0],"startY",h);e.data(i[0],"diffX",p-c);e.data(i[0],"diffY",d-h)}if(l.rotate){if(a==1){e.data(i[0],"rotatePoint1X",s);e.data(i[0],"rotatePoint1Y",o)}else if(a==2){var v=r.originalEvent.touches[1].pageX,m=r.originalEvent.touches[1].pageY,g=e.data(i[0],"rotatePoint1X"),y=e.data(i[0],"rotatePoint1Y");e.data(i[0],"rotatePoint2X",v);e.data(i[0],"rotatePoint2Y",m);e.data(i[0],"startDegree",f(g,y,v,m));e.data(i[0],"_startDegree",e.data(i[0],"currDegree"));e.data(i[0],"rotation",true)}}if(l.resize&&a==2){e.data(i[0],"startWidth",t.width());e.data(i[0],"startHeight",t.height());var p=r.originalEvent.touches[0].pageX,d=r.originalEvent.touches[0].pageY,b=r.originalEvent.touches[1].pageX,w=r.originalEvent.touches[1].pageY,E=b-p,S=w-d,x=Math.sqrt(E*E+S*S);e.data(i[0],"startDistance",x)}}).unbind("touchmove.touchBox mousemove.touchBox").bind("touchmove.touchBox mousemove.touchBox",function(n){var i=e(this),s=e.data(i[0],"touches"),o=e.data(i[0],"options");if(o.callback_touches!=null)o.callback_touches.apply(this,[s]);if(o.resize&&s==2){var u=n.originalEvent.touches[0].pageX,a=n.originalEvent.touches[0].pageY,l=n.originalEvent.touches[1].pageX,c=n.originalEvent.touches[1].pageY,h=l-u,p=c-a,d=Math.sqrt(h*h+p*p),v=(d-e.data(i[0],"startDistance"))/2,m=e.data(i[0],"startWidth")+(d-e.data(i[0],"startDistance")),g=e.data(i[0],"startHeight")+(d-e.data(i[0],"startDistance")),y=e.data(i[0],"startX")-v,b=e.data(i[0],"startY")-v;t.css({width:m+"px",height:g+"px",left:y+"px",top:b+"px"});if(o.callback_size_change!=null)o.callback_size_change.apply(this,[m,g]);if(o.callback_position_change!=null)o.callback_position_change.apply(this,[y,b])}if(o.drag&&!e.data(i[0],"ignoreTouch")&&s==1){var u=typeof n.pageX!="undefined"?n.pageX:n.originalEvent.touches[0].pageX,a=typeof n.pageY!="undefined"?n.pageY:n.originalEvent.touches[0].pageY,y=u-e.data(i[0],"diffX"),b=a-e.data(i[0],"diffY");t.css({left:Math.floor(y/o.grid_drag)*o.grid_drag+"px",top:Math.floor(b/o.grid_drag)*o.grid_drag+"px"});if(o.callback_position_change!=null)o.callback_position_change.apply(this,[y,b])}if(o.rotate&&e.data(i[0],"rotation")){var w=e.data(i[0],"currDegree"),E=(e.data(i[0],"startDegree")-f(n.originalEvent.touches[0].pageX,n.originalEvent.touches[0].pageY,n.originalEvent.touches[1].pageX,n.originalEvent.touches[1].pageY)-e.data(i[0],"_startDegree"))*-1;e.data(i[0],"currDegree",E);i.css(r,"rotate("+Math.floor(E)+"deg)");if(o.callback_degree_change!=null)o.callback_degree_change.apply(this,[w,E])}n.preventDefault()}).unbind("touchend.touchBox mouseup.touchBox").bind("touchend.touchBox mouseup.touchBox",function(t){var n=e(this),r=e.data(n[0],"options"),i=e.data(n[0],"touches");i-=1;e.data(n[0],"touches",i);if(i==1)e.data(n[0],"ignoreTouch",true);e.data(n[0],"rotation",false);if(r.callback_touches!=null)r.callback_touches.apply(this,[i])})})};e(document).ready(function(){var n=e(".touch-box");if(n.length>0){n.each(function(){var n=e(this),r={drag:false,resize:false,rotate:false},i=n.attr("data-resize"),s=n.attr("data-drag"),o=n.attr("data-rotate");if(i!=t&&i=="true")r["resize"]=true;if(s!=t&&s=="true")r["drag"]=true;if(o!=t&&o=="true")r["rotate"]=true;n.TouchBox(r)})}})})(jQuery)