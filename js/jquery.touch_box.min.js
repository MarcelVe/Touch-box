/**
    Touch box - Enabled resize, drag & rotate of DOM elements on the web for iPad and other touch devices.
    Copyright (C) 2013 Dannie Hansen
 
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
 **/
(function(e){"use strict";function f(e,t,n,r){var i=e-n,s=t-r,o=Math.atan2(s,i);return o*180/Math.PI}var t,n=400,r="Transform",i="TransformOrigin",s=["O","ms","Webkit","Moz"],o=s.length,u=document.createElement("div"),a=u.style;while(o--){if(s[o]+r in a){r=s[o]+r;i=s[o]+i}}e.fn.TouchBox=function(s){var o={drag:false,resize:false,rotate:false,callback_touches:null,callback_size_change:null,callback_position_change:null,callback_degree_change:null};if(s!=t)e.extend(o,s);this.each(function(){var t=e(this),s=0,u=0,a=0,l=0,c=0,h=0,p=false,d=0,v=0,m=0,g=0,y=0,b=0,w=false,E=0,S=0,x=0;if(o.rotate)this.style[i]="center center";t[0]["draggable"]=false;t.bind("touchstart mousedown",function(e){n+=1;t.css({zIndex:n});s=typeof e.pageX!="undefined"?1:e.originalEvent.touches.length;if(p)p=false;var r=typeof e.pageX!="undefined"?e.pageX:e.originalEvent.touches[0].pageX,i=typeof e.pageY!="undefined"?e.pageY:e.originalEvent.touches[0].pageY;if(!p){var T=parseFloat(t.css("left"),10),N=parseFloat(t.css("top"),10),C=r,k=i;d=T;v=N;u=C-T;a=k-N}if(o.rotate){if(s==1){m=r;g=i}else if(s==2){y=e.originalEvent.touches[1].pageX;b=e.originalEvent.touches[1].pageY;E=f(m,g,y,b);x=S;w=true}}if(o.resize&&s==2){l=t.width();c=t.height();var C=e.originalEvent.touches[0].pageX,k=e.originalEvent.touches[0].pageY,L=e.originalEvent.touches[1].pageX,A=e.originalEvent.touches[1].pageY,O=L-C,M=A-k,_=Math.sqrt(O*O+M*M);h=_}}).bind("touchmove mousemove",function(e){if(o.callback_touches!=null)o.callback_touches.apply(this,[s]);if(o.resize&&s==2){var n=e.originalEvent.touches[0].pageX,i=e.originalEvent.touches[0].pageY,m=e.originalEvent.touches[1].pageX,g=e.originalEvent.touches[1].pageY,y=m-n,b=g-i,T=Math.sqrt(y*y+b*b),N=(T-h)/2,C=l+(T-h),k=c+(T-h),L=d-N,A=v-N;t.css({width:C+"px",height:k+"px",left:L+"px",top:A+"px"});if(o.callback_size_change!=null)o.callback_size_change.apply(this,[C,k]);if(o.callback_position_change!=null)o.callback_position_change.apply(this,[L,A])}if(o.drag&&!p&&s==1){var n=typeof e.pageX!="undefined"?e.pageX:e.originalEvent.touches[0].pageX,i=typeof e.pageY!="undefined"?e.pageY:e.originalEvent.touches[0].pageY,L=n-u,A=i-a;t.css({left:L+"px",top:A+"px"});if(o.callback_position_change!=null)o.callback_position_change.apply(this,[L,A])}if(o.rotate&&w){var O=S,M=(E-f(e.originalEvent.touches[0].pageX,e.originalEvent.touches[0].pageY,e.originalEvent.touches[1].pageX,e.originalEvent.touches[1].pageY)-x)*-1;S=M;this.style[r]="rotate("+Math.floor(M)+"deg)";if(o.callback_degree_change!=null)o.callback_degree_change.apply(this,[O,M])}e.preventDefault()}).bind("touchend mouseup",function(e){s-=1;if(s==1)p=true;w=false;if(o.callback_touches!=null)o.callback_touches.apply(this,[s])})})};e(document).ready(function(){var n=e(".touch-box");if(n.length>0){n.each(function(){var n=e(this),r={drag:false,resize:false,rotate:false},i=n.attr("data-resize"),s=n.attr("data-drag"),o=n.attr("data-rotate");if(i!=t&&i=="true")r["resize"]=true;if(s!=t&&s=="true")r["drag"]=true;if(o!=t&&o=="true")r["rotate"]=true;n.TouchBox(r)})}})})(jQuery)